<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="icon" type="image/x-icon" href="favicon.ico">
	<title>AOC</title>
   <!-- Tailwind CSS CDN -->
   <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
   <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.min.js"></script>
</head>
<body class="bg-gray-500 text-gray-900 mb-12">
	<div id="app">
      <!-- Event Duration -->
      <div class="w-full mb-1 flex justify-end fixed bottom-0">
         <div class="flex flex-row gap-2 items-center bg-gray-300 rounded-lg pl-2 pr-2">
            <h2 class="block text-lg font-semibold">Area of Conquest:</h2>
            <p>{{ formattedEventDuration }}</p>
         </div>
      </div>

      <!-- Total Points -->
      <div class="w-full fixed top-0 z-50 flex flex-row gap-2 mb-4 select-none text-center">
         <!-- Team Panels -->
         <div class="w-full border rounded-lg p-2 bg-red-100 text-red-800 font-semibold">
            <div class="flex flex-col items-center">
               <span class="flex items-center">
                 Total:
                 <img src="superior_coins.png" class="w-5 h-5 mx-1" />
                 {{ totalSuperiorCoins("red") }}
               </span>
               <span class="flex gap-2 items-center">
                 <span class="flex items-center">
                   <img src="superior_coins.png" class="w-5 h-5 mr-1" />
                   {{ coinsperminute("red") }}/min
                 </span>
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                      stroke-width="1.5" stroke="currentColor" class="size-6">
                   <path stroke-linecap="round" stroke-linejoin="round"
                         d="m2.25 12 8.954-8.955c.44-.439 
                         1.152-.439 1.591 0L21.75 12M4.5 
                         9.75v10.125c0 .621.504 1.125 
                         1.125 1.125H9.75v-4.875c0-.621.504-1.125 
                         1.125-1.125h2.25c.621 0 1.125.504 
                         1.125 1.125V21h4.125c.621 0 
                         1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                 </svg>
                 {{ locationCounts.red }}
               </span>
             </div>
         </div>
         <div class="w-full border rounded-lg p-2 bg-orange-100 text-orange-800 font-semibold">
            <div class="flex flex-col items-center">
               <span class="flex items-center">
                 Total:
                 <img src="superior_coins.png" class="w-5 h-5 mx-1" />
                 {{ totalSuperiorCoins("orange") }}
               </span>
               <span class="flex gap-2 items-center">
                 <span class="flex items-center">
                   <img src="superior_coins.png" class="w-5 h-5 mr-1" />
                   {{ coinsperminute("orange") }}/min
                 </span>
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                      stroke-width="1.5" stroke="currentColor" class="size-6">
                   <path stroke-linecap="round" stroke-linejoin="round"
                         d="m2.25 12 8.954-8.955c.44-.439 
                         1.152-.439 1.591 0L21.75 12M4.5 
                         9.75v10.125c0 .621.504 1.125 
                         1.125 1.125H9.75v-4.875c0-.621.504-1.125 
                         1.125-1.125h2.25c.621 0 1.125.504 
                         1.125 1.125V21h4.125c.621 0 
                         1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                 </svg>
                 {{ locationCounts.orange }}
               </span>
             </div>
         </div>
         <div class="w-full border rounded-lg p-2 bg-blue-100 text-blue-800 font-semibold">
            <div class="flex flex-col items-center">
               <span class="flex items-center">
                 Total:
                 <img src="superior_coins.png" class="w-5 h-5 mx-1" />
                 {{ totalSuperiorCoins("blue") }}
               </span>
               <span class="flex gap-2 items-center">
                 <span class="flex items-center">
                   <img src="superior_coins.png" class="w-5 h-5 mr-1" />
                   {{ coinsperminute("blue") }}/min
                 </span>
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                      stroke-width="1.5" stroke="currentColor" class="size-6">
                   <path stroke-linecap="round" stroke-linejoin="round"
                         d="m2.25 12 8.954-8.955c.44-.439 
                         1.152-.439 1.591 0L21.75 12M4.5 
                         9.75v10.125c0 .621.504 1.125 
                         1.125 1.125H9.75v-4.875c0-.621.504-1.125 
                         1.125-1.125h2.25c.621 0 1.125.504 
                         1.125 1.125V21h4.125c.621 0 
                         1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                 </svg>
                 {{ locationCounts.blue }}
               </span>
             </div>
         </div>
         <div class="w-full border rounded-lg p-2 bg-violet-100 text-violet-800 font-semibold">
            <div class="flex flex-col items-center">
               <span class="flex items-center">
                 Total:
                 <img src="superior_coins.png" class="w-5 h-5 mx-1" />
                 {{ totalSuperiorCoins("violet") }}
               </span>
               <span class="flex gap-2 items-center">
                 <span class="flex items-center">
                   <img src="superior_coins.png" class="w-5 h-5 mr-1" />
                   {{ coinsperminute("violet") }}/min
                 </span>
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                      stroke-width="1.5" stroke="currentColor" class="size-6">
                   <path stroke-linecap="round" stroke-linejoin="round"
                         d="m2.25 12 8.954-8.955c.44-.439 
                         1.152-.439 1.591 0L21.75 12M4.5 
                         9.75v10.125c0 .621.504 1.125 
                         1.125 1.125H9.75v-4.875c0-.621.504-1.125 
                         1.125-1.125h2.25c.621 0 1.125.504 
                         1.125 1.125V21h4.125c.621 0 
                         1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                 </svg>
                 {{ locationCounts.violet }}
               </span>
             </div>
         </div>
      </div>

      <!-- Location Grid -->
      <div class="grid lg:grid-cols-24 md:grid-cols-5 gap-1 mt-20">
         <div 
            v-for="location in locationData"
            :key="location.id"
            :class="['text-sm border flex select-none flex-col items-center rounded-lg w-full border-white border-2 row-span-4 shadow-md transform hover:scale-105 transition duration-300 ease-in-out', getGridClasses(location)]"
            @click="openLocationDialog(location)">
               <div class="w-full flex flex-col items-center">
                  <div>
                     <span class="font-bold underline pr-1">{{ location.ppm }}</span>
                     <span class="font-bold uppercase">{{ location.name }}</span>
                  </div>
                  <div class="font-bold">
                     <span v-if="location.teampower">{{ location.teampower }} K</span>
                     <span v-else>0</span>
                  </div>
               </div>
         </div>
      </div>



      <!-- Dialog Box -->
      <div v-if="isDialogOpen" class="select-none fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm">
         <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md space-y-6 animate-fade-in">
            <h2 class="text-xl font-bold text-gray-800 text-center">Update Capture Info</h2>
            <div>
               <p class="block text-sm font-medium text-gray-700 mb-2">Captured By</p>
               <div class="flex gap-3 flex-wrap justify-center">
                  <div
                     v-for="color in teamColors"
                     :key="color.value"
                     class="flex flex-col items-center cursor-pointer"
                     @click="selectColor(color.value)">
                     <div :class="[
                           'w-10 h-10 rounded-full border-2 transition-all duration-200',
                           selectedLocation.capturedByColor === color.value
                              ? 'ring-4 ring-offset-2 ring-blue-500 scale-110'
                              : 'opacity-70 hover:opacity-100 hover:scale-105',
                           color.class
                        ]"></div>
                     <span class="text-xs mt-1 font-medium text-gray-700">{{ color.label }}</span>
                  </div>
               </div>
            </div>
            <div>
               <label for="powerInput" class="block text-sm font-medium text-gray-700 mb-1">Team Power (K)</label>
               <input
                  v-model="selectedLocation.teampower"
                  type="number"
                  id="powerInput"
                  min="0"
                  placeholder="e.g. 250"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
               />
            </div>
            <div class="flex justify-end gap-3 pt-2">
               <button @click="closeDialog" class="px-4 py-2 rounded-lg bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold transition">Cancel</button>
               <button @click="saveLocationData" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition">Save</button>
            </div>
         </div>
      </div>

      <!-- Floating Action Buttons -->
      <div class="fixed bottom-12 right-6 flex flex-col items-end gap-3 z-50">
         <!-- Download Button -->
         <button
            @click="downloadLocationData"
            class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg"
            title="Download Data"
         >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
               <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
             </svg>
             
         </button>

         <!-- Upload Button -->
         <label
            for="uploadInput"
            class="bg-blue-500 hover:bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg cursor-pointer"
            title="Upload Data"
         >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
               <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
            </svg>
            <input
               id="uploadInput"
               type="file"
               accept=".json"
               class="hidden"
               @change="uploadLocationData"
            />
         </label>
      </div>
   </div>

   <script>
      const app = Vue.createApp({
         data() {
            return {
               startDate: null,
               endDate: null,
               locationData: [],
               timerInterval: null,
               isDialogOpen: false,
               selectedLocation: null,
               remainingTime: 0,
               teamColors: [
                  { label: 'White', value: 'white', class: 'bg-gray-300 border-gray-400' },
                  { label: 'Red', value: 'red', class: 'bg-red-600 border-red-800' },
                  { label: 'Orange', value: 'orange', class: 'bg-orange-500 border-orange-700' },
                  { label: 'Blue', value: 'blue', class: 'bg-blue-600 border-blue-800' },
                  { label: 'Violet', value: 'violet', class: 'bg-violet-600 border-violet-800' }
               ]
            };
         },
         computed: {
            eventDuration() {
               if (this.remainingTime <= 0) {
                  return { eventDurationDays: 0, eventDurationHours: 0, eventDurationMinutes: 0, eventDurationSeconds: 0 };
               }
               const totalMinutes = Math.floor(this.remainingTime / (1000 * 60));
               const eventDurationDays = Math.floor(totalMinutes / 1440);
               const eventDurationHours = Math.floor((totalMinutes % 1440) / 60);
               const eventDurationMinutes = totalMinutes % 60;
               const eventDurationSeconds = Math.floor((this.remainingTime % (1000 * 60)) / 1000);
               return {
                  eventDurationDays,
                  eventDurationHours,
                  eventDurationMinutes,
                  eventDurationSeconds
               };
            },
            formattedEventDuration() {
               const d = this.eventDuration;
               return `${String(d.eventDurationDays).padStart(2, '0')}:${String(d.eventDurationHours).padStart(2, '0')}:${String(d.eventDurationMinutes).padStart(2, '0')}:${String(d.eventDurationSeconds).padStart(2, '0')}`;
            },
            locationCounts() {
               return {
                  red: this.locationData.filter(loc => loc.capturedByColor === 'red').length,
                  orange: this.locationData.filter(loc => loc.capturedByColor === 'orange').length,
                  blue: this.locationData.filter(loc => loc.capturedByColor === 'blue').length,
                  violet: this.locationData.filter(loc => loc.capturedByColor === 'violet').length
               };
            }
         },
         methods: {
            getGridClasses(location) {
               return [
                  `lg:col-start-${location.colstart}`,
                  `lg:col-end-${location.colend}`,
                  `md:col-start-${location.colstart}`,
                  `md:col-end-${location.colend}`,
                  `row-start-${location.rowstart}`,
                  this.getCardColor(location.capturedByColor)
               ];
            },
            selectColor(color) {
               this.selectedLocation.capturedByColor = color;
            },
            getCardColor(teamColor) {
               switch (teamColor) {
                  case 'red': return 'bg-red-500 text-white';
                  case 'orange': return 'bg-orange-500 text-white';
                  case 'blue': return 'bg-blue-500 text-white';
                  case 'violet': return 'bg-violet-500 text-white';
                  default: return 'bg-gray-200';
               }
            },
            startCountdown() {
               this.remainingTime = this.endDate - new Date();
               if (this.remainingTime <= 0) return;
               this.timerInterval = setInterval(() => {
                  this.remainingTime = this.endDate - new Date();
                  if (this.remainingTime <= 0) {
                     clearInterval(this.timerInterval);
                     this.remainingTime = 0;
                  }
               }, 1000);
            },
            coinsperminute(team) {
               return this.locationData
                  .filter(loc => loc.capturedByColor === team)
                  .reduce((sum, loc) => sum + (parseInt(loc.ppm) || 0), 0);
            },
            totalSuperiorCoins(team) {
               const totalPPM = this.locationData
                  .filter(loc => loc.capturedByColor === team)
                  .reduce((sum, loc) => sum + (parseInt(loc.ppm) || 0), 0);

               const remainingMinutes = Math.max(Math.floor(this.remainingTime / (1000 * 60)), 0);

               return totalPPM * remainingMinutes;
            },                            
            openLocationDialog(location) {
               this.selectedLocation = { ...location };
               this.isDialogOpen = true;
            },
            closeDialog() {
               this.isDialogOpen = false;
               this.selectedLocation = null;
            },
            saveLocationData() {
               const index = this.locationData.findIndex(loc => loc.id === this.selectedLocation.id);
               if (index !== -1) {
                  this.locationData[index] = { ...this.selectedLocation };
                  this.saveToLocalStorage();
               }
               this.closeDialog();
            },
            saveToLocalStorage() {
               localStorage.setItem('eventData', JSON.stringify({
                  locations: this.locationData
               }));
            },
            downloadLocationData() {
               const dataStr = JSON.stringify(this.locationData, null, 2);
               const blob = new Blob([dataStr], { type: 'application/json' });
               const url = URL.createObjectURL(blob);
               const link = document.createElement('a');
               link.href = url;
               link.download = 'locationData.json';
               link.click();
               URL.revokeObjectURL(url);
            },
            uploadLocationData(event) {
               const file = event.target.files[0];
               if (!file) return;

               const reader = new FileReader();
               reader.onload = (e) => {
                  try {
                     const data = JSON.parse(e.target.result);
                     if (Array.isArray(data)) {
                        this.locationData = data;
                        this.saveToLocalStorage();
                     } else {
                        alert('Invalid JSON format.');
                     }
                  } catch (err) {
                     alert('Error parsing file.');
                  }
                  // Reset file input
                  event.target.value = '';
               };
               reader.readAsText(file);
            }
         },
         created() {
            this.startDate = new Date();

            const savedData = localStorage.getItem('eventData');
            if (savedData) {
               const parsed = JSON.parse(savedData);
               this.locationData = parsed.locations || [];
            }

            fetch('event_time.json')
               .then(response => response.json())
               .then(data => {
                  this.endDate = new Date(data.endDate);
                  this.startDate = new Date(data.startDate);
                  if (this.startDate <= new Date()) {
                     this.startCountdown();
                  }
               })
               .catch(err => {
                  console.error('Failed to load event time:', err);
                  this.endDate = new Date(Date.now() + 2 * 24 * 60 * 60 * 1000); // fallback 2-day event
                  this.startCountdown();
               });

            fetch('location.json')
               .then(response => response.json())
               .then(data => {
                  if (!this.locationData || this.locationData.length === 0) {
                     this.locationData = data.locationData;
                     this.saveToLocalStorage();
                  }
               })
               .catch(err => {
                  console.error('Failed to load location data:', err);
               });
         }
      });

      app.mount('#app');
   </script>
</body>
</html>
